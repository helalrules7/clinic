<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار ميزات الأدوية الجديدة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .drug-suggestion-badge {
            transition: all 0.2s ease;
            font-size: 0.75rem;
            padding: 0.35rem 0.6rem;
            border-radius: 15px;
            line-height: 1.2;
            cursor: pointer;
        }
        .drug-suggestion-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            background-color: #0d6efd !important;
        }
        #drugSuggestions {
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            background: white;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            z-index: 1050;
            max-height: 200px;
            overflow-y: auto;
        }
        .suggestion-item {
            transition: background-color 0.15s ease;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f8f9fa !important;
        }
        
        /* Usage Count Badge - Red Circle with White Text */
        .usage-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #dc3545 !important;
            color: white !important;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.6rem;
            font-weight: bold;
            margin-left: 0.4rem;
            min-width: 16px;
            line-height: 1;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">اختبار ميزات الأدوية الجديدة</h4>
                    </div>
                    <div class="card-body">
                        <!-- Most Used Drugs Suggestions -->
                        <div class="mb-4">
                            <label class="form-label">الأدوية الأكثر استخداماً</label>
                            <div id="mostUsedDrugs" class="d-flex flex-wrap gap-2">
                                <div class="text-muted">
                                    <i class="bi bi-hourglass-split me-1"></i>جاري تحميل الاقتراحات...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Drug Name Input with Autocomplete -->
                        <div class="mb-3">
                            <label class="form-label">اسم الدواء <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="drugNameInput" placeholder="اكتب اسم الدواء..." autocomplete="off">
                                <div id="drugSuggestions" class="position-absolute w-100" style="display: none;"></div>
                            </div>
                        </div>
                        
                        <!-- Test Results -->
                        <div class="mt-4">
                            <h6>نتائج الاختبار:</h6>
                            <div id="testResults" class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                اختر دواء من الاقتراحات أو اكتب في حقل البحث لاختبار الميزات
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load most used drugs and display as clickable badges
        async function loadMostUsedDrugs() {
            try {
                const response = await fetch('/api/getMostUsedDrugs?limit=10');
                const data = await response.json();
                
                const container = document.getElementById('mostUsedDrugs');
                if (data.drugs && data.drugs.length > 0) {
                    container.innerHTML = '';
                    data.drugs.forEach(drug => {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-primary me-2 mb-2 drug-suggestion-badge';
                        badge.innerHTML = `
                            <i class="bi bi-capsule me-1"></i>
                            ${drug.drug_name}
                            <span class="usage-count-badge">${drug.usage_count}</span>
                        `;
                        badge.title = `استُخدم ${drug.usage_count} مرة. الجرعات الشائعة: ${drug.common_doses || 'غير متوفر'}. التكرار الشائع: ${drug.common_frequencies || 'غير متوفر'}`;
                        
                        badge.addEventListener('click', () => {
                            document.getElementById('drugNameInput').value = drug.drug_name;
                            document.getElementById('drugSuggestions').style.display = 'none';
                            updateTestResults(`تم اختيار الدواء: ${drug.drug_name} (استُخدم ${drug.usage_count} مرة)`);
                        });
                        
                        container.appendChild(badge);
                    });
                } else {
                    container.innerHTML = '<div class="text-muted"><i class="bi bi-info-circle me-1"></i>لا توجد بيانات استخدام للأدوية</div>';
                }
            } catch (error) {
                console.error('Error loading most used drugs:', error);
                const container = document.getElementById('mostUsedDrugs');
                container.innerHTML = '<div class="text-muted"><i class="bi bi-exclamation-triangle me-1"></i>فشل في تحميل الاقتراحات</div>';
            }
        }

        // Setup autocomplete functionality for drug name input
        function setupDrugNameAutocomplete() {
            const drugNameInput = document.getElementById('drugNameInput');
            const suggestionsContainer = document.getElementById('drugSuggestions');
            let searchTimeout;
            
            drugNameInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (searchTerm.length < 3) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchDrugsAutocomplete(searchTerm);
                }, 300);
            });
            
            document.addEventListener('click', function(e) {
                if (!drugNameInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
            
            drugNameInput.addEventListener('focus', function() {
                if (this.value.trim().length >= 3) {
                    searchDrugsAutocomplete(this.value.trim());
                }
            });
        }

        // Search drugs for autocomplete
        async function searchDrugsAutocomplete(searchTerm) {
            try {
                const response = await fetch(`/api/searchDrugsAutocomplete?q=${encodeURIComponent(searchTerm)}&limit=6`);
                const data = await response.json();
                
                const suggestionsContainer = document.getElementById('drugSuggestions');
                
                if (data.drugs && data.drugs.length > 0) {
                    suggestionsContainer.innerHTML = '';
                    
                    data.drugs.forEach(drug => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'p-2 border-bottom suggestion-item';
                        suggestionItem.innerHTML = `
                            <div class="fw-bold text-primary">${drug.drug_name}</div>
                            <small class="text-muted">${drug.active_ingredient || ''} ${drug.Company ? '- ' + drug.Company : ''}</small>
                        `;
                        
                        suggestionItem.addEventListener('click', () => {
                            document.getElementById('drugNameInput').value = drug.drug_name;
                            suggestionsContainer.style.display = 'none';
                            updateTestResults(`تم اختيار الدواء من البحث التلقائي: ${drug.drug_name}`);
                        });
                        
                        suggestionItem.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = '#f8f9fa';
                        });
                        
                        suggestionItem.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = '';
                        });
                        
                        suggestionsContainer.appendChild(suggestionItem);
                    });
                    
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.innerHTML = '<div class="p-2 text-muted text-center">لم يتم العثور على أدوية</div>';
                    suggestionsContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('Error searching drugs:', error);
                const suggestionsContainer = document.getElementById('drugSuggestions');
                suggestionsContainer.innerHTML = '<div class="p-2 text-danger text-center">خطأ في تحميل الاقتراحات</div>';
                suggestionsContainer.style.display = 'block';
            }
        }

        function updateTestResults(message) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = `<i class="bi bi-check-circle me-2"></i>${message}`;
            resultsDiv.className = 'alert alert-success';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadMostUsedDrugs();
            setupDrugNameAutocomplete();
        });
    </script>
</body>
</html>
